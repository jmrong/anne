<!DOCTYPE html>
<html>
    <head>
        <title>anne</title>
        <style>
            html, body {
                height: 100vh;
                width: 100vw;
                padding: 0;
                margin: 0;
            }
            #big {
                height: 100vh;
                width: 100vw;
                background-color: rgb(100, 100, 100);
            }
            #big:active {
                filter: brightness(90%);
            }
        </style>
    </head>
    <body>
        <div id = "big" onclick = "handleClick()"></div>
        <script
  src="https://code.jquery.com/jquery-3.7.1.js"
  integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
  crossorigin="anonymous"></script>
        <script src="@picovoice/web-voice-processor/dist/iife/index.js"></script>
        <script src="@picovoice/porcupine-web/dist/iife/index.js"></script>
        <script>
            function changeColor(color, fade) {
                if (fade) {
                    $("#big").css("transition", "background-color 0.75s");
                } else {
                    $("#big").css("transition", "");
                }
                $("#big").css("background-color", color);
            }

            const apiKey = localStorage.getItem("apiKey");
            async function startPorcupine() {
                changeColor("cornflowerblue", false);

                const keywordModel = {
                    publicPath: "Hey-there-Anne_en_wasm_v3_0_0.ppn",
                    label: "hey_there_anne",
                }

                function keywordDetectionCallback(detection) {
                    console.log(`Porcupine detected keyword index: ${detection.label}`);
                    startListening();
                }

                const porcupine = await PorcupineWeb.PorcupineWorker.create(
                    apiKey,
                    [keywordModel],
                    keywordDetectionCallback,
                    {
                        publicPath: "porcupine_params.pv"
                    }
                );

                await window.WebVoiceProcessor.WebVoiceProcessor.subscribe(porcupine);
            }

            const recognitionSvc = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new recognitionSvc();
            recognition.lang = 'en-US';
            function startListening() {
                changeColor("aqua", true);

                recognition.start();
                recognition.onresult = (event) => { 
                    for (const result of event.results) {
                        console.log(`${result[0].transcript}`);
                        processQuery(result[0].transcript.toLowerCase());
                    }
                }
            }

            const synth = window.speechSynthesis;
            function speakText(text) {
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.rate = 1.2;
                utterThis.addEventListener("end", () => {
                    setTimeout(() => {
                        changeColor("cornflowerblue", true);
                    }, 200);
                });
                synth.speak(utterThis);
            }

            const actions = {
                "girlfriend_hi": {
                    hotwords: ["girlfriend"],
                    action: sayHi
                },
                "menu": {
                    hotwords: ["menu", "dinner", "lunch", "kathy", "bartlett", "woodlawn", "baker"],
                    action: foodMenu
                },
                "cta_train": {
                    hotwords: ["red line", "green line", "cottage grove", "garfield"],
                    action: ctaTrain
                }
            }

            function sayHi() {
                setTimeout(() => {
                    speakText("Hello, Grace!");
                }, 200);
            }

            function ctaTrain(query) {
                const trainKey = localStorage.getItem("trainKey");
                let stpid = "", service = "";
                if (query.includes("red")) {
                    stpid = "30223";
                    service = "Garfield Red Line towards Howard";
                } else if (query.inclues("green") && query.includes("garfield")) {
                    stpid = "30099";
                    service = "Garfield Green Line towards Harlem";
                } else if (query.includes("green")) {
                    stpid = "30140";
                    service = "Cottage Grove Green Line towards Harlem";
                } else {
                    return;
                }
                $.ajax({
                    url: `https://lapi.transitchicago.com/api/1.0/ttarrivals.aspx?key=${trainKey}&stpid=${stpid}`
                }).done(data => {
                    const arrivals = [];
                    $(data).find("eta").each(function() {
                        const arrT = $(this).find("arrT").text();
                        const arrDate = new Date(Number(arrT.substring(0, 4)), Number(arrT.substring(4, 6), ));
                    });
                });
            }

            function foodMenu(query) {
                const today = new Date();
                const locations = {
                    "kathy": "618a6efbb63f1e2d444389c1",
                    "woodlawn": "618a6df9b63f1e2d692b1f5c",
                    "bartlett": "618a6f95b63f1e2d3b454065",
                    "baker": "618a6caab63f1e2d4442bdf5"
                }
                const mealPeriods = {
                    "kathy": {
                        "dinner": "6761d823c625af07f6c1efd2",
                        "lunch": "6761d823c625af07f6c1efb6"
                    },
                    "woodlawn": {
                        "dinner": "65098cc9e45d430aa3542a3a",
                        "lunch": "65098cc9e45d430aa3542a18"
                    },
                    "bartlett": {
                        "dinner": "677abc04351d53055638c7b5",
                        "lunch": "677abc04351d53055638c78c"
                    },
                    "baker": {
                        "dinner": "677a9ed5e45d4305ef20f265",
                        "lunch": "677a9ed5e45d4305ef20f277"
                    }
                }
                const stations = {
                    "kathy": ["Kitchen", "Rooted Entrees and Sides", "Halal", "Kosher"],
                    "woodlawn": ["Kitchen", "Rooted Entrees and Sides", "Pure Eats Entrée and Sides", "Kosher Entrees", "Halal", "Crave Global"],
                    "baker": ["Kitchen", "Kitchen Special", "Rooted", "Pure Eats Entrée and Sides", "Kosher", "Halal"]
                }
                let location = "";
                if (query.includes("kathy")) {
                    location = "kathy";
                } else if (query.includes("woodlawn")) {
                    location = "woodlawn";
                } else if (prevAction.actionType == "menu") {
                    location = prevAction.actionData.location;
                }
                let period = "";
                if (query.includes("dinner")) {
                    period = "dinner";
                } else if (query.includes("lunch")) {
                    period = "lunch";
                } else if (prevAction.actionType == "menu") {
                    period = prevAction.actionData.period;
                }
                prevAction.actionData = {
                    "location": location,
                    "period": period
                };
                $.ajax({
                    url: `https://api.dineoncampus.com/v1/location/${locations[location]}/periods/${mealPeriods[location][period]}?platform=0&date=${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`
                }).done(data => {
                    try {
                        const output = [`Here is the menu for ${period} at ${location}.`];
                        const categories = data.menu.periods.categories;
                        categories.forEach(category => {
                            if (stations[location].includes(category.name)) {
                                output.append(`The ${category.name} station has ${category.items.slice(0, 4).map((item, i) => i == category.items.length - 1 ? 'and ' + item.name : item.name).join(', ')}.`);
                            }
                        });
                        speakText(output);
                    } catch (error) {
                        console.log(error);
                        speakText(`Unfortunately, I was unable to get the menu for ${period} at ${location}.`);
                    }
                }).catch((error) => {
                    console.log(error);
                    speakText(`Unfortunately, I was unable to get the menu for ${period} at ${location}.`);
                })
            }

            let prevAction = { actionType: null, actionData: null };
            function processQuery(result) {
                for (let action in actions) {
                    for (let hotword of actions[action].hotwords) {
                        if (result.includes(hotword)) {
                            prevAction.actionType = action;
                            actions[action].action(result);
                            return;
                        }
                    }
                }
            }

            let state = "inactive";
            function handleClick() {
                startPorcupine();
            }
        </script>
    </body>
</html>