<!DOCTYPE html>
<html>
    <head>
        <title>anne</title>
        <style>
            html, body {
                height: 100vh;
                width: 100vw;
                padding: 0;
                margin: 0;
            }
            #big {
                height: 100vh;
                width: 100vw;
                background-color: rgb(100, 100, 100);
            }
            #big:active {
                filter: brightness(90%);
            }
        </style>
    </head>
    <body>
        <div id = "big" onclick = "handleClick()"></div>
        <script
  src="https://code.jquery.com/jquery-3.7.1.js"
  integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
  crossorigin="anonymous"></script>
        <script src="@picovoice/web-voice-processor/dist/iife/index.js"></script>
        <script src="@picovoice/porcupine-web/dist/iife/index.js"></script>
        <script>
            function changeColor(color, fade) {
                if (fade) {
                    $("#big").css("transition", "background-color 0.5s");
                } else {
                    $("#big").css("transition", "");
                }
                $("#big").css("background-color", color);
            }

            const apiKey = localStorage.getItem("apiKey");
            async function startPorcupine() {
                changeColor("cornflowerblue", false);

                const keywordModel = {
                    publicPath: "Hey-there-Anne_en_wasm_v3_0_0.ppn",
                    label: "hey_there_anne",
                }

                function keywordDetectionCallback(detection) {
                    console.log(`Porcupine detected keyword index: ${detection.label}`);
                    startListening();
                }

                const porcupine = await PorcupineWeb.PorcupineWorker.create(
                    apiKey,
                    [keywordModel],
                    keywordDetectionCallback,
                    {
                        publicPath: "porcupine_params.pv"
                    }
                );

                await window.WebVoiceProcessor.WebVoiceProcessor.subscribe(porcupine);
            }

            const recognitionSvc = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new recognitionSvc();
            recognition.lang = 'en-US';
            function startListening() {
                changeColor("aqua", true);

                recognition.start();
                recognition.onresult = (event) => { 
                    for (const result of event.results) {
                        console.log(`${result[0].transcript}`);
                        processQuery(result[0].transcript.toLowerCase());
                    }
                }
            }

            const synth = window.speechSynthesis;
            function speakText(text) {
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.rate = 1.4;
                utterThis.addEventListener("end", () => {
                    setTimeout(() => {
                        changeColor("cornflowerblue", true);
                    }, 200);
                });
                setTimeout(() => {
                    synth.speak(utterThis);
                }, 200);
            }

            const actions = {
                "girlfriend_hi": {
                    hotwords: ["girlfriend"],
                    action: sayHi
                },
                "menu": {
                    hotwords: ["menu", "dinner", "lunch", "kathy", "bartlett"],
                    action: foodMenu
                }
            }

            function sayHi() {
                speakText("Hello, Grace!");
            }
            function foodMenu(query) {
                const today = new Date();
                const locations = {
                    "kathy": "618a6efbb63f1e2d444389c1",
                    "woodlawn": "618a6df9b63f1e2d692b1f5c"
                }
                const mealPeriods = {
                    "kathy": {
                        "dinner": "6761d823c625af07f6c1efd2"
                    },
                    "woodlawn": {
                        "dinner": "65098cc9e45d430aa3542a3a"
                    }
                }
                let location = "";
                if (query.includes("kathy")) {
                    location = "kathy";
                } else if (query.includes("woodlawn")) {
                    location = "woodlawn";
                } else if (prevAction.actionType == "menu") {
                    period = prevAction.actionData.location;
                }
                let period = "";
                if (query.includes("dinner")) {
                    period = "dinner";
                } else if (prevAction.actionType == "menu") {
                    period = prevAction.actionData.period;
                }
                prevAction.actionData = {
                    "location": location,
                    "period": period
                };
                $.ajax({
                    url: `https://api.dineoncampus.com/v1/location/${locations[location]}/periods/${mealPeriods[location][period]}?platform=0&date=${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`
                }).done(function(data) {
                    speakText(`For ${period}, we have ${data.menu.periods.categories[0].items[0].name}`);
                });
            }

            let prevAction = { actionType: null, actionData: null };
            function processQuery(result) {
                for (let action in actions) {
                    for (let hotword of actions[action].hotwords) {
                        if (result.includes(hotword)) {
                            prevAction.actionType = action;
                            actions[action].action(result);
                            return;
                        }
                    }
                }
            }

            let state = "inactive";
            function handleClick() {
                startPorcupine();
            }
        </script>
    </body>
</html>