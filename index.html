<!DOCTYPE html>
<html>
    <head>
        <title>anne</title>
        <style>
            html, body {
                height: 100vh;
                width: 100vw;
                padding: 0;
                margin: 0;
            }
            #big {
                height: 100vh;
                width: 100vw;
                background-color: rgb(100, 100, 100);
            }
            #big:active {
                filter: brightness(90%);
            }
        </style>
    </head>
    <body>
        <div id = "big" onclick = "handleClick()"></div>
        <script
  src="https://code.jquery.com/jquery-3.7.1.js"
  integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
  crossorigin="anonymous"></script>
        <script src="@picovoice/web-voice-processor/dist/iife/index.js"></script>
        <script src="@picovoice/porcupine-web/dist/iife/index.js"></script>
        <script>
            function changeColor(color, fade) {
                if (fade) {
                    $("#big").css("transition", "background-color 0.5s");
                } else {
                    $("#big").css("transition", "");
                }
                $("#big").css("background-color", color);
            }

            const apiKey = localStorage.getItem("apiKey");
            async function startPorcupine() {
                changeColor("cornflowerblue", false);

                const keywordModel = {
                    publicPath: "Hey-there-Anne_en_wasm_v3_0_0.ppn",
                    label: "hey_there_anne",
                }

                function keywordDetectionCallback(detection) {
                    console.log(`Porcupine detected keyword index: ${detection.label}`);
                    startListening();
                }

                const porcupine = await PorcupineWeb.PorcupineWorker.create(
                    apiKey,
                    [keywordModel],
                    keywordDetectionCallback,
                    {
                        publicPath: "porcupine_params.pv"
                    }
                );

                await window.WebVoiceProcessor.WebVoiceProcessor.subscribe(porcupine);
            }

            const recognitionSvc = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new recognitionSvc();
            recognition.lang = 'en-US';
            function startListening() {
                changeColor("aqua", true);

                recognition.start();
                recognition.onresult = (event) => { 
                    for (const result of event.results) {
                        console.log(`${result[0].transcript}`);
                        processQuery(result[0].transcript);
                    }
                }
            }

            const synth = window.speechSynthesis;
            function speakText(text) {
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.addEventListener("end", () => {
                    changeColor("cornflowerblue", true);
                });
                synth.speak(utterThis);
            }
            function processQuery(result) {
                if (result.indexOf("hi") != -1 && result.indexOf("girlfriend") != -1) {
                    speakText("Hello, Grace!");
                }
            }

            let state = "inactive";
            function handleClick() {
                startPorcupine();
            }
        </script>
    </body>
</html>